#!/usr/bin/env ruby

require 'bunny'
require 'pry'

class MQ
  class << self
    def subscribe_sync(queue_name, consumer_tag=:default, timeout=5)
      client = Bunny.new
      client.start

      queue = client.queue queue_name

      status = Timeout::timeout(timeout) {
        queue.subscribe(:consumer_tag => consumer_tag) do |msg|
          return msg
        end
      }

    rescue Timeout::Error => e
      raise "Noesis::MQ.subscribe_sync timeout error: timeout=#{timeout}"
    ensure
      binding.pry
      client.stop
    end  
  end
end

puts MQ.subscribe_sync(:test_me)
